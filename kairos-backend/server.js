require('dotenv').config(); const express = require("express"); const cors = require("cors"); const helmet = require("helmet"); const path = require("path"); const logger = require("./lib/logger"); const routes = require("./routes"); const rateLimit = require("express-rate-limit"); const app = express(); app.use(helmet({ contentSecurityPolicy: false, })); const ALLOWED_ORIGINS = (process.env.ALLOWED_ORIGINS || "").split(",").map(s => s.trim()).filter(Boolean); app.use(cors({ origin: (origin, cb) => { if (!origin) return cb(null, true); if (ALLOWED_ORIGINS.length === 0 || ALLOWED_ORIGINS.includes(origin)) return cb(null, true); cb(new Error("Origin not allowed")); } })); app.use(express.json()); const limiter = rateLimit({ windowMs: parseInt(process.env.RATE_WINDOW_MS || "15") * 60 * 1000, max: parseInt(process.env.RATE_MAX || "200"), standardHeaders: true, legacyHeaders: false, }); app.use(limiter); const landingPath = path.join(__dirname, '../landing'); app.use('/landing', express.static(landingPath)); app.get("/ready", (req, res) => { res.json({ status: "ok", version: process.env.KAIROS_VERSION || "3.9.4", time: new Date().toISOString() }); }); app.get("/status", (req, res) => { res.json({ status: "ok", message: "Kairós Online", version: process.env.KAIROS_VERSION || "3.9.4", time: new Date().toISOString() }); }); app.post('/landing/subscribe', async (req, res) => { const { email } = req.body; if (!email || typeof email !== 'string' || !email.includes('@')) return res.status(400).json({ error: "Email inválido" }); try { if (process.env.SUPABASE_URL) { const supabase = require('./services/supabaseClient')(); const { error } = await supabase.from('landing_subscribers').insert([{ email }]); if (error && error.code !== '23505') throw error; } logger.info(`New subscriber: ${email}`); res.json({ ok: true, message: "Inscrito!" }); } catch (e) { logger.error({ err: e }, "Subscribe Error"); res.status(500).json({ error: "Erro ao salvar" }); } }); app.use("/", routes); app.use((err, req, res, next) => { logger.error({ err }, "Unhandled error"); res.status(500).json({ error: err.message || 'Internal Error' }); }); const PORT = process.env.PORT || 10000; const HOST = process.env.HOST || "0.0.0.0"; app.listen(PORT, HOST, () => { logger.info(`KAIRÓS Server ${process.env.KAIROS_VERSION || 'v3.9.4'} running on ${PORT}`); logger.info(`Landing Page available at http://localhost:${PORT}/landing/`); });