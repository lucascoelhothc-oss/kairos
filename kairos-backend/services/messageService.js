const supabase = require("./supabaseClient"); const IS_MOCK = !process.env.SUPABASE_URL; exports.ensureUser = async(u) => { if(IS_MOCK) return {id:'mock'}; const {data,error} = await supabase.from('users').upsert({id:u.id,email:u.email||'anon'},{onConflict:'email'}).select().single(); if(error) return {id:'temp'}; return data; }; exports.saveMessage = async(d) => { if(IS_MOCK) return {id:Date.now()}; const {data}=await supabase.from('messages').insert([d]).select().single(); return data; }; exports.getMessagesForUser = async(u) => { if(IS_MOCK) return []; const {data}=await supabase.from('messages').select('*').eq('user_id',u.user_id).limit(u.limit); return data||[]; };